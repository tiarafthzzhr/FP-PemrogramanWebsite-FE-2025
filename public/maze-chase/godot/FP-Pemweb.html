<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0"
    />
    <title>FP-Pemweb</title>
    <style>
      html,
      body,
      #canvas {
        margin: 0;
        padding: 0;
        border: 0;
      }

      body {
        color: white;
        background-color: black;
        overflow: hidden;
        touch-action: none;
      }

      #canvas {
        display: block;
      }

      #canvas:focus {
        outline: none;
      }
    </style>
    <link
      id="-gd-engine-icon"
      rel="icon"
      type="image/png"
      href="FP-Pemweb.icon.png"
    />
    <link rel="apple-touch-icon" href="FP-Pemweb.apple-touch-icon.png" />
  </head>
  <body>
    <canvas id="canvas"> Your browser does not support the canvas tag. </canvas>

    <noscript> Your browser does not support JavaScript. </noscript>

    <script src="FP-Pemweb.js"></script>
    <script>
      const GODOT_CONFIG = {
        args: [],
        canvasResizePolicy: 2,
        emscriptenPoolSize: 8,
        ensureCrossOriginIsolationHeaders: true,
        executable: "FP-Pemweb",
        experimentalVK: false,
        fileSizes: { "FP-Pemweb.pck": 15918208, "FP-Pemweb.wasm": 36145869 },
        focusCanvas: true,
        gdextensionLibs: [],
        godotPoolSize: 4,
      };
      const GODOT_THREADS_ENABLED = false;
      const engine = new Engine(GODOT_CONFIG);

      (function () {
        const missing = Engine.getMissingFeatures({
          threads: GODOT_THREADS_ENABLED,
        });

        if (missing.length !== 0) {
          if (
            GODOT_CONFIG["serviceWorker"] &&
            GODOT_CONFIG["ensureCrossOriginIsolationHeaders"] &&
            "serviceWorker" in navigator
          ) {
            let serviceWorkerRegistrationPromise;
            try {
              serviceWorkerRegistrationPromise =
                navigator.serviceWorker.getRegistration();
            } catch (err) {
              serviceWorkerRegistrationPromise = Promise.reject(
                new Error("Service worker registration failed."),
              );
            }
            // There's a chance that installing the service worker would fix the issue
            Promise.race([
              serviceWorkerRegistrationPromise
                .then((registration) => {
                  if (registration != null) {
                    return Promise.reject(
                      new Error("Service worker already exists."),
                    );
                  }
                  return registration;
                })
                .then(() => engine.installServiceWorker()),
              // For some reason, `getRegistration()` can stall
              new Promise((resolve) => {
                setTimeout(() => resolve(), 2000);
              }),
            ])
              .then(() => {
                // Reload if there was no error.
                window.location.reload();
              })
              .catch((err) => {
                console.error("Error while registering service worker:", err);
              });
          } else {
            // Display the message as usual
            const missingMsg =
              "Error\nThe following features required to run Godot projects on the Web are missing:\n";
            alert(missingMsg + missing.join("\n"));
          }
        } else {
          engine
            .startGame({
              onProgress: function (current, total) {},
            })
            .then(
              () => {
                // Game started
              },
              (err) => {
                console.error(err);
              },
            );
        }
      })();
    </script>
  </body>
</html>
